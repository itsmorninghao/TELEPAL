# Bot æ¨¡å—

Telegram Bot çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·æ¶ˆæ¯ã€å‘½ä»¤å’Œå®šæ—¶ä»»åŠ¡ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
bot/
â”œâ”€â”€ __init__.py              # æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
â”œâ”€â”€ command_handlers.py      # å‘½ä»¤å¤„ç†å™¨
â”œâ”€â”€ commands.py              # å‘½ä»¤å…ƒæ•°æ®å®šä¹‰
â”œâ”€â”€ filters.py               # æ¶ˆæ¯è¿‡æ»¤å™¨
â”œâ”€â”€ message_handlers.py      # æ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ location_service.py      # ä½ç½®æœåŠ¡
â”œâ”€â”€ middleware.py           # Bot ä¸­é—´ä»¶
â””â”€â”€ scheduler_service.py     # å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡
```

## ğŸ“„ æ–‡ä»¶è¯´æ˜

### `command_handlers.py`
å‘½ä»¤å¤„ç†å™¨ï¼Œå®ç°æ‰€æœ‰å‘½ä»¤çš„è·¯ç”±å¤„ç†ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- **ç¾¤ç»„æˆæƒç®¡ç†**ï¼ˆä»…è¶…ç®¡ï¼‰
  - `/group_authorize <chat_id>` - æˆæƒç¾¤ç»„
  - `/group_revoke <chat_id>` - æ’¤é”€ç¾¤ç»„æˆæƒ
  - `/group_list` - æŸ¥çœ‹æ‰€æœ‰å·²æˆæƒç¾¤ç»„

- **ç™½åå•ç®¡ç†**ï¼ˆè¶…ç®¡/ç¾¤ç®¡ï¼‰
  - `/whitelist_add <user_id> [private|group] [chat_id]` - æ·»åŠ ç™½åå•ç”¨æˆ·
  - `/whitelist_remove <user_id> [private|group] [chat_id]` - ç§»é™¤ç™½åå•ç”¨æˆ·
  - `/whitelist_list [private|group] [chat_id]` - æŸ¥çœ‹ç™½åå•åˆ—è¡¨

- **æƒé™ç®¡ç†**ï¼ˆä»…è¶…ç®¡ï¼‰
  - `/permission_set <user_id> <role>` - è®¾ç½®ç”¨æˆ·æƒé™

- **è®°å¿†ç®¡ç†**
  - `/memory_list [user_id] [query]` - æŸ¥çœ‹é•¿æœŸè®°å¿†
  - `/memory_delete [user_id] <memory_key>` - åˆ é™¤é•¿æœŸè®°å¿†

- **å…¶ä»–å‘½ä»¤**
  - `/set_location` - è®¾ç½®ä½ç½®ä¿¡æ¯ï¼ˆç§èŠæ”¯æŒåˆ†äº«ä½ç½®ï¼Œç¾¤èŠä»…æ”¯æŒæ‰‹åŠ¨é€‰æ‹©ï¼‰
  - `/help` - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

**ä¾èµ–ï¼š**
- `commands.py` - ç”¨äºç”Ÿæˆå¸®åŠ©æ–‡æœ¬
- `filters.py` - æƒé™å’ŒèŠå¤©ç±»å‹è¿‡æ»¤

---

### `commands.py`
å‘½ä»¤å…ƒæ•°æ®å®šä¹‰æ¨¡å—ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†å‘½ä»¤ä¿¡æ¯å’Œç”Ÿæˆå¸®åŠ©æ–‡æœ¬ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- å®šä¹‰ `CommandMetadata` æ•°æ®ç±»ï¼ŒåŒ…å«å‘½ä»¤åç§°ã€æè¿°ã€ç”¨æ³•ã€æƒé™è¦æ±‚ç­‰
- æä¾› `generate_help_text()` å‡½æ•°ï¼Œæ ¹æ®ç”¨æˆ·è§’è‰²å’ŒèŠå¤©ç±»å‹åŠ¨æ€ç”Ÿæˆå¸®åŠ©ä¿¡æ¯
- æä¾›å‘½ä»¤è¿‡æ»¤å‡½æ•°ï¼ŒæŒ‰è§’è‰²æˆ–èŠå¤©ç±»å‹ç­›é€‰å¯ç”¨å‘½ä»¤

**æ•°æ®ç»“æ„ï¼š**
```python
@dataclass
class CommandMetadata:
    name: str                    # å‘½ä»¤åç§°
    description: str            # å‘½ä»¤æè¿°
    usage: str                  # ä½¿ç”¨è¯´æ˜
    required_role: str          # æ‰€éœ€æƒé™
    allowed_chat_types: List[str] # å…è®¸ä½¿ç”¨çš„åœºæ™¯
```

---

### `filters.py`
æ¶ˆæ¯è¿‡æ»¤å™¨æ¨¡å—ï¼Œæä¾›å„ç§æ¶ˆæ¯è¿‡æ»¤é€»è¾‘ã€‚

**ä¸»è¦è¿‡æ»¤å™¨ï¼š**

1. **`RoleFilter`** - æƒé™è¿‡æ»¤å™¨
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æŒ‡å®šè§’è‰²ï¼ˆsuper_adminã€group_adminï¼‰
   - æ”¯æŒç§èŠå’Œç¾¤ç»„åœºæ™¯

2. **`PrivateChatFilter`** - ç§èŠæ¶ˆæ¯è¿‡æ»¤å™¨
   - æ£€æŸ¥æ˜¯å¦ä¸ºç§èŠæ¶ˆæ¯

3. **`GroupChatFilter`** - ç¾¤ç»„æ¶ˆæ¯è¿‡æ»¤å™¨
   - æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤ç»„æ¶ˆæ¯

4. **`NotCommandFilter`** - éå‘½ä»¤æ¶ˆæ¯è¿‡æ»¤å™¨
   - è¿‡æ»¤æ‰ä»¥ `/` å¼€å¤´çš„å‘½ä»¤æ¶ˆæ¯

5. **`GroupMentionFilter`** - ç¾¤ç»„ @ æåŠè¿‡æ»¤å™¨
   - æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ @ æåŠäº†æœºå™¨äºº
   - æ”¯æŒå¤šç§æåŠæ–¹å¼ï¼ˆ@usernameã€text_mentionã€command@botï¼‰

6. **`ReplyMessageFilter`** - å›å¤æ¶ˆæ¯è¿‡æ»¤å™¨
   - æ£€æŸ¥æ˜¯å¦ä¸ºå›å¤æ¶ˆæ¯

7. **`ReplyToBotFilter`** - å›å¤æœºå™¨äººæ¶ˆæ¯è¿‡æ»¤å™¨
   - æ£€æŸ¥æ˜¯å¦ä¸ºå›å¤æœºå™¨äººå‘é€çš„æ¶ˆæ¯

**ç»„åˆè¿‡æ»¤å™¨ï¼š**
- `PrivateOrMentionFilter` - ç§èŠæˆ–ç¾¤ç»„ @ æåŠ
- `ReplyFilter` - å›å¤æ¶ˆæ¯ï¼ˆç§èŠæˆ–ç¾¤ç»„ï¼‰

---

### `message_handlers.py`
æ¶ˆæ¯å¤„ç†å™¨æ¨¡å—ï¼Œå¤„ç†ç”¨æˆ·æ¶ˆæ¯å’Œä½ç½®ä¿¡æ¯ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

1. **`handle_chat()`** - å¤„ç†èŠå¤©æ¶ˆæ¯
   - è°ƒç”¨ AI Agent ç”Ÿæˆå›å¤
   - å¤„ç†å›å¤æ¶ˆæ¯ä¸Šä¸‹æ–‡
   - æ ¼å¼åŒ–å¹¶å‘é€å›å¤ï¼ˆMarkdownV2ï¼‰

2. **`handle_location()`** - å¤„ç†ä½ç½®ä¿¡æ¯
   - æ ¹æ®ç»çº¬åº¦è·å–æ—¶åŒº
   - ä¿å­˜ç”¨æˆ·ä½ç½®åˆ°æ•°æ®åº“

3. **è·¯ç”±å¤„ç†å™¨ï¼š**
   - `handle_location_message()` - å¤„ç†ä½ç½®æ¶ˆæ¯
   - `handle_message()` - å¤„ç†éå‘½ä»¤æ¶ˆæ¯ï¼ˆAI å¯¹è¯ï¼‰
     - ç§èŠï¼šæ£€æŸ¥æˆæƒåå¤„ç†
     - ç¾¤ç»„ï¼šæ£€æŸ¥ç¾¤ç»„æˆæƒã€ç”¨æˆ·æˆæƒï¼Œä»…å¤„ç† @ æåŠæˆ–å›å¤æœºå™¨äººçš„æ¶ˆæ¯

**ä¾èµ–ï¼š**
- `filters.py` - æ¶ˆæ¯è¿‡æ»¤
- `location_service.py` - ä½ç½®æœåŠ¡
- `src.agent.graph` - AI Agent å›¾

---

### `location_service.py`
ç”¨æˆ·ä½ç½®æœåŠ¡æ¨¡å—ï¼Œå¤„ç†ä½ç½®ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

1. **`get_timezone_from_location()`** - æ ¹æ®ç»çº¬åº¦è·å–æ—¶åŒº
   - ä½¿ç”¨ `timezonefinder` åº“è·å–å‡†ç¡®çš„æ—¶åŒºä¿¡æ¯
   - è¿”å›æ—¶åŒºå­—ç¬¦ä¸²ï¼ˆå¦‚ 'Asia/Shanghai'ï¼‰

2. **`save_user_location()`** - ä¿å­˜ç”¨æˆ·ä½ç½®ä¿¡æ¯
   - ä¿å­˜ç”¨æˆ· IDã€ç»çº¬åº¦ã€æ—¶åŒºåˆ°æ•°æ®åº“

3. **`get_user_location()`** - è·å–ç”¨æˆ·ä½ç½®ä¿¡æ¯
   - ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„ä½ç½®ä¿¡æ¯

**ä¾èµ–ï¼š**
- `timezonefinder` - æ—¶åŒºæŸ¥æ‰¾åº“
- `src.database.repositories.profiles` - æ•°æ®åº“ä»“åº“

---

### `middleware.py`
Bot ä¸­é—´ä»¶æ¨¡å—ï¼Œæä¾›å…¨å±€çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ã€‚

**ä¸­é—´ä»¶ï¼š**

1. **`LoggingMiddleware`** - æ—¥å¿—ä¸­é—´ä»¶
   - è®°å½•æ‰€æœ‰æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨æˆ· IDã€èŠå¤©ç±»å‹ã€èŠå¤© IDã€æ¶ˆæ¯ IDï¼‰

2. **`ErrorHandlingMiddleware`** - é”™è¯¯å¤„ç†ä¸­é—´ä»¶
   - æ•è·æ‰€æœ‰å¤„ç†è¿‡ç¨‹ä¸­çš„å¼‚å¸¸
   - æ ¹æ®é”™è¯¯ç±»å‹è¿”å›å‹å¥½çš„é”™è¯¯æç¤º
   - é˜²æ­¢å¼‚å¸¸å½±å“å…¶ä»–æ¶ˆæ¯å¤„ç†

**é”™è¯¯åˆ†ç±»ï¼š**
- æ•°æ®åº“é”™è¯¯ â†’ "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
- API é”™è¯¯ â†’ "AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
- ç½‘ç»œé”™è¯¯ â†’ "ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•"
- å…¶ä»–é”™è¯¯ â†’ "å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"

---

### `scheduler_service.py`
å®šæ—¶ä»»åŠ¡è°ƒåº¦æœåŠ¡æ¨¡å—ï¼Œä½¿ç”¨ APScheduler ç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

1. **`SchedulerService`** - å•ä¾‹è°ƒåº¦æœåŠ¡ç±»
   - ç®¡ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œ
   - ç³»ç»Ÿå¯åŠ¨æ—¶ä»æ•°æ®åº“æ¢å¤æœªæ‰§è¡Œçš„ä»»åŠ¡
   - ä»»åŠ¡åˆ°æœŸæ—¶è§¦å‘å›è°ƒå‘é€æé†’æ¶ˆæ¯

2. **ä¸»è¦æ–¹æ³•ï¼š**
   - `initialize(bot)` - åˆå§‹åŒ–è°ƒåº¦å™¨ï¼ŒåŠ è½½å¾…æ‰§è¡Œä»»åŠ¡
   - `add_task(...)` - æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆä¿å­˜åˆ°æ•°æ®åº“å¹¶æ·»åŠ åˆ°è°ƒåº¦å™¨ï¼‰
   - `_load_pending_tasks()` - ä»æ•°æ®åº“åŠ è½½å¾…æ‰§è¡Œä»»åŠ¡
   - `_execute_task(task_id)` - æ‰§è¡Œä»»åŠ¡å›è°ƒï¼ˆå‘é€æé†’æ¶ˆæ¯ï¼‰
   - `shutdown()` - å…³é—­è°ƒåº¦å™¨

3. **`get_scheduler_service()`** - è·å–å•ä¾‹å®ä¾‹

**å·¥ä½œæµç¨‹ï¼š**
1. ä»»åŠ¡åˆ›å»ºæ—¶å…ˆä¿å­˜åˆ°æ•°æ®åº“
2. å¦‚æœæ‰§è¡Œæ—¶é—´åœ¨æœªæ¥ï¼Œæ·»åŠ åˆ°å†…å­˜è°ƒåº¦å™¨
3. ç³»ç»Ÿå¯åŠ¨æ—¶ä»æ•°æ®åº“æ¢å¤æœªæ‰§è¡Œçš„ä»»åŠ¡
4. ä»»åŠ¡åˆ°æœŸæ—¶å‘é€æé†’æ¶ˆæ¯å¹¶æ ‡è®°ä¸ºå·²æ‰§è¡Œ

**ä¾èµ–ï¼š**
- `apscheduler` - å¼‚æ­¥ä»»åŠ¡è°ƒåº¦åº“
- `src.database.repositories.scheduled_tasks` - ä»»åŠ¡æ•°æ®åº“ä»“åº“

---

## ğŸ”„ æ¨¡å—é—´å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚command_handlers â”‚ â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    commands     â”‚ â”€â”€â”¼â”€â”€> å‘½ä»¤å…ƒæ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚message_handlers â”‚ â”€â”€â”¼â”€â”€> æ¶ˆæ¯å¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    filters      â”‚ â”€â”€â”˜â”€â”€> æ¶ˆæ¯è¿‡æ»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ä½¿ç”¨
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   middleware    â”‚ â”€â”€> å…¨å±€ä¸­é—´ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚location_service â”‚ â”€â”€> ä½ç½®æœåŠ¡ï¼ˆç‹¬ç«‹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚scheduler_serviceâ”‚ â”€â”€> å®šæ—¶ä»»åŠ¡ï¼ˆç‹¬ç«‹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— ç›¸å…³æ¨¡å—

- `src.auth` - è®¤è¯å’Œæƒé™ç®¡ç†
- `src.agent` - AI Agent å›¾
- `src.database` - æ•°æ®åº“æ“ä½œ
- `src.utils` - å·¥å…·å‡½æ•°
